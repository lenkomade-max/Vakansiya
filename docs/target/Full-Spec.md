## Vakansiya.az — Полная спецификация (что должно быть реализовано)

— Цель: единый документ требований. Только «что должно быть», без описания текущего статуса.

### 1. Архитектура и окружения
- Next.js 15 (App Router), TypeScript, Tailwind CSS
- Серверный рендеринг для SEO-страниц, client components для интерактивных блоков
- Supabase как BaaS: аутентификация, базы данных (PostgreSQL), RLS
- Внешние сервисы: Google OAuth, Brevo (email), Google AdSense, аналитика (GA4, Meta Pixel), объектное хранилище Supabase Storage
- Окружения: development, staging, production; отдельные переменные окружения для каждого

### 2. Аутентификация и роли
- Вход через Google OAuth (Supabase Auth)
- Роли: guest, user, employer, admin (роль хранится в таблице профилей и/или JWT custom claims)
- Обязательная верификация email через Google-аккаунт (политика безопасности)
- Защищенные роуты: /profile/* (user), /employer/* (employer), /admin/* (admin)

### 3. Модель данных (Supabase PostgreSQL)
- Таблица users (из Supabase)
- Таблица profiles
  - id (uuid, pk, = user.id)
  - role (enum: user|employer|admin)
  - full_name, phone, avatar_url, created_at, updated_at
- Таблица companies
  - id, name, slug, logo_url, industry, size, city, verified, description, created_by
- Таблица jobs (обычные вакансии)
  - id, company_id, title, description, city, salary_from, salary_to, salary_currency, employment_type, experience_level, category, is_premium, is_urgent, created_at, published_at, expires_at, views
- Таблица short_jobs (gündəlik işlər)
  - id, category, title, city, pay_amount, pay_unit (hour|day), starts_at, duration, address, description, requirements, contact_phone, is_vip, is_urgent, created_at
- Таблица applications (отклики)
  - id, job_id, user_id, status (submitted|viewed|rejected|invited), message, created_at
- Таблица favorites (избранное)
  - id, user_id, entity_type (job|company|short_job), entity_id, created_at
- Таблица ads_settings (AdSense/позиции/ключи), marketing_subscriptions
- Таблица audit_log (изменения админом)
- RLS-политики для безопасного доступа (user видит/меняет только своё; employer видит свои вакансии; admin — всё)

### 4. Публичные маршруты (Frontend)
- `/` Главная: поиск, категории, блок вакансий и gündəlik işlər, CTA
- `/vakansiyalar` Каталог вакансий: фильтры, сортировки, пагинация/инфинит скролл
- `/vakansiyalar/[id]` Детальная вакансия: описание, компания, похожие вакансии, действия
- `/gundelik-isler` Каталог коротких работ: категории, фильтры, карта (позже), быстрый контакт
- `/gundelik-isler/[id]` Детальная короткая работа: фото/иконка, оплата, время, контакт
- `/companies` Список компаний с фильтрами
- `/companies/[id|slug]` Профиль компании: о компании, активные вакансии, контакты
- `/about`, `/contact`, `/terms`, `/privacy`, `/pricing`, `/faq` статические страницы

### 5. Закрытые маршруты
- `/post-job` Размещение вакансии/короткой работы (для employer)
- `/profile` Личный кабинет соискателя: отклики, резюме, сохранённые, настройки
- `/employer` Кабинет работодателя: вакансии (CRUD), отклики, статистика, биллинг
- `/admin` Админка: модерация вакансий/компаний/пользователей, настройки, аудит

### 6. Функции каталога вакансий
- Фильтры: категория, город, зарплата (range), тип работы, опыт, компания, дата
- Сортировки: по дате, зарплате, релевантности
- Вид: сетка/список, инфинит скролл, сохранённые поиски
- Карточки: бейджи (VIP, Premium, Urgent), короткие атрибуты

### 7. Gündəlik İşlər (короткие работы)
- Обязательная зарплата и единица (час/день)
- Категории с иконками (10 базовых)
- Быстрый контакт: «Позвонить»/«WhatsApp» (без формы отклика)
- Простая форма создания (категория, оплата, дата, адрес, контакт)

### 8. Профиль пользователя (user)
- Резюме: личные данные, опыт, образование, навыки, языки, портфолио, загрузка PDF
- Отклики: список, статусы, уведомления
- Сохранённые вакансии/компании
- Настройки приватности резюме

### 9. Кабинет работодателя (employer)
- Мои вакансии: список, создать, редактировать, снять с публикации, дублировать
- Отклики: статусы, фильтры, комментарии
- Профиль компании: логотип, cover, описания, соцсети, галерея, контакты
- Биллинг: тарифы (Free, Premium, VIP), баланс, транзакции, инвойсы

### 10. Админ-панель (admin)
- Модерация вакансий/коротких работ: статусы (ожидает/одобрено/отклонено), причина
- Управление компаниями: верификация, блокировка, редактирование
- Управление пользователями: роли, блокировка, активность
- Платежи: список транзакций, подтверждение
- Настройки сайта: категории, города, тарифы, email-шаблоны, реклама
- Аудит-лог всех админских изменений

### 11. Автопарсинг (отдельный сервис)
- Источники: tap.az, boss.az, ejob.az (конфигурируемый список)
- Периодичность: cron (каждый час/настройка)
- Pipeline:
  1) Scraper: собирает данные (заголовок, описание, компания, город, зарплата, категория, ссылка-источник)
  2) Dedup: проверка дублей (по хешу ключевых полей + нормализованному тексту)
  3) AI Standardization: нормализация полей (категория, опыт, зарплата, метки VIP/Urgent) через ИИ-агент
  4) Validation: обязательные поля (минимум: title, city, description)
  5) Enrichment: извлечение зарплаты/локации из текста
  6) Publish: POST в публичный API проекта (`/api/import-jobs`)
- Логи, retry стратегия, dead-letter очередь

### 12. ИИ-агент для нормализации (OpenRouter/локальная LLM)
- Инструкции/промпт для стандартизации вакансий: извлечение структуры из текста
- Маппинг категорий к фиксированному справочнику
- Выделение сущностей (город, опыт, зарплата, тип занятости)
- Антиспам/регулирование токсичного контента
- Ограничение стоимости: кэширование результатов, батчинг запросов

### 13. Публичный API (Next.js Route Handlers)
- `POST /api/import-jobs` приём батча вакансий от парсера
  - Валидация схемы (zod)
  - Защита: bearer token
  - Запись в `jobs` и/или `companies` при необходимости
- `GET /api/jobs` параметры фильтрации/сортировки/пагинации
- `GET /api/jobs/[id]`
- `POST /api/applications` создать отклик (для user)
- `GET /api/companies`, `GET /api/companies/[id]`
- Rate limiting и basic abuse protection

### 14. Уведомления (In-app и Email)
- In-app колокольчик: список последних событий (ответы, статус отклика)
- Email (Brevo):
  - Транзакционные письма: подтверждение отклика, смена статуса, публикация вакансии
  - Маркетинговые кампании (конфигурируемые, opt-in для соответствия политике)
- Шаблоны в базе, возможность A/B тестирования

### 15. Реклама (Google AdSense)
- In-Feed/Responsive блоки в списках вакансий и gündəlik işlər
- Позиции: каждая 8-я карточка (конфигурируемо)
- Переменные окружения: client, slot ids, фолбэк при отсутствии ключей

### 16. Поиск
- Глобальный поиск по вакансиям и компаниям
- Автокомплит по заголовкам/категориям/компаниям
- История запросов (локально/под аккаунтом пользователя)

### 17. SEO и производительность
- Метаданные (title/description), Open Graph, JSON-LD для вакансий/компаний
- Sitemap и robots
- Canonical URLs
- Оптимизация картинок, lazy loading, code splitting
- Lighthouse 90+

### 18. Аналитика
- Google Analytics 4 (события: просмотр списка, просмотр вакансии, отклик, сохранение)
- Meta Pixel (конверсии)
- Heatmaps (Hotjar)

### 19. Безопасность и соответствие
- RLS политики для всех пользовательских таблиц
- Input validation на API слоях (zod)
- Rate limiting и защита от спама (honeypot, captcha при аномалиях)
- HTTPS-only, secure cookies, CSP заголовки, защита от XSS/CSRF
- Логи доступа/ошибок, алерты

### 20. Биллинг и монетизация
- Тарифы для работодателей: Free (до N объявлений), Premium (безлимит), VIP опции
- Платежи: локальные провайдеры/Stripe (этапами), записи транзакций, инвойсы PDF
- Ограничения публикации по тарифу/балансу

### 21. Нефункциональные требования
- Доступность (ARIA, контраст, клавиатурная навигация)
- Локализация (AZ/EN/RU — этапно)
- Масштабирование: горизонтальное (внешний парсер отдельно), кеш CDN для публичных страниц

### 22. DevOps и процессы
- CI: lint, type-check, build, preview deploy (Vercel)
- CD: production deploy с ручным подтверждением
- Миграции БД (Supabase migrations)
- Backups БД (ежедневно), мониторинг ошибок (Sentry)

### 23. Roadmap (этапы)
1) MVP: каталоги/детальные, постинг, Google OAuth, Supabase, базовые фильтры
2) Employer cabinet + отклики, избранное, In-Feed реклама
3) Автопарсинг + ИИ-нормализация + импорт API
4) Биллинг/тарифы, админка модерации
5) SEO/аналитика, маркетинг, оптимизации

### 24. Переменные окружения (пример)
- NEXT_PUBLIC_SITE_URL
- NEXT_PUBLIC_ADSENSE_CLIENT, NEXT_PUBLIC_ADSENSE_SLOT_VAKANSIYALAR, NEXT_PUBLIC_ADSENSE_SLOT_GUNDELIK
- NEXT_PUBLIC_SUPABASE_URL, NEXT_PUBLIC_SUPABASE_ANON_KEY
- SUPABASE_SERVICE_ROLE_KEY (server-only)
- IMPORT_JOBS_BEARER_TOKEN (server-only)
- OPENROUTER_API_KEY (или локальная LLM)
- BREVO_API_KEY

### 25. Критерии готовности
- Все описанные маршруты доступны и соответствуют требованиям
- Полные RLS политики и авторизация по ролям
- Доступен импорт вакансий через API и по автопарсингу
- Прохождение чек-листов UX, SEO, Lighthouse, безопасность
- Набор e2e сценариев: публикация вакансии, отклик, модерация, импорт

